parameters:
  - name: terraformWorkspaceEnv
    type: string
    default: false
  - name: terraformVersion
    type: string
    default: false
  - name: terraformPath
    type: string
    default: false
  - name: terraformPlanFile
    type: string
    default: false
  - name: resourceContainer
    type: string
    default: false
  - name: githubConnection
    type: string
    default: false
  - name: gitubRepositoryName
    type: string
    default: false
  - name: githubPullRequestId
    type: number
    default: 0
  - name: githubPullRequestComment
    type: string
    default: false

jobs:
  - job: "TerraformPR"
    displayName: "Terraform PR"
    container: ${{ parameters.resourceContainer }}
    steps:
      - template: ../pipeline-tasks/tfenv-terraform-install.yaml
        parameters:
          terraformVersion: ${{ parameters.terraformVersion }}
      - template: ../pipeline-tasks/terraform-fmt.yaml
        parameters:
          terraformPath: ${{ parameters.terraformPath }}
      - template: ../pipeline-tasks/terraform-init.yaml
        parameters:
          terraformPath: ${{ parameters.terraformPath }}
      - template: ../pipeline-tasks/terraform-workspace.yaml
        parameters:
          terraformPath: ${{ parameters.terraformPath }}
          terraformWorkspaceEnv: ${{ parameters.terraformWorkspaceEnv }}
      - template: ../pipeline-tasks/terraform-validate.yaml
        parameters:
          terraformPath: ${{ parameters.terraformPath }}
      - template: ../pipeline-tasks/tflint-run.yaml
        parameters:
          terraformPath: ${{ parameters.terraformPath }}
      - template: ../pipeline-tasks/tfsec-run.yaml
        parameters:
          terraformPath: ${{ parameters.terraformPath }}
      - template: ../pipeline-tasks/terraform-plan.yaml
        parameters:
          terraformPath: ${{ parameters.terraformPath }}
          terraformPlanFile: ${{ parameters.terraformPlanFile }}
      # - template: ../pipeline-tasks/terraform-cache.yaml
      #   parameters:
      #     terraformPath: ${{ parameters.terraformPath }}
      #     terraformPlanFile: ${{ parameters.terraformPlanFile }}
      - template: ../pipeline-tasks/github-pr-comment.yaml
        parameters:
          githubConnection: ${{ parameters.githubConnection }}
          gitubRepositoryName: ${{ parameters.gitubRepositoryName }}
          githubPullRequestId: ${{ parameters.githubPullRequestId }}
          githubPullRequestComment: ${{ parameters.githubPullRequestComment }}
